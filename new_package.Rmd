---
title: "Starting a New R Package"
author: "Ben Heavner"
date: "4/3/2017"
output: 
  html_document: # see here for docs: http://rmarkdown.rstudio.com/html_document_format.html
    toc: true # table of content true
    toc_float: true # floating TOC
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    theme: united  # many options for theme - see http://bootswatch.com/
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction

Here are a few notes on starting an R package. For context, I've previously made a [skeleton package](https://github.com/bheavner/packageTest). That may be worth looking at, at least because there's some useful links in the README, but in this case, I'll be doing things a tiny bit differently by starting with an existing R script. 

The current goal is to make a set of R functions to obtain gene definitions from an outside data source and make a table of those gene definitions in the GAC database. We'll bundle those functions up as an R package so it's easy to get them and reuse them, and I'll put the code on github because that's an easy way to distribute it and allow installation from any Internet-connected workstation.

Coming up with a name is always a hard part - I want something that is general enough, but specific enough.. It's hopeless. So, rather than getting too hung up on it, I'll remember that it can always be changed later. For now, I'll call the project, repository, and R package **geneTable**.

Basically, this is a second iteration on the skeleton package idea.

## Initializing an R Package

I generally put all the code I'm working on in a directory called `projects` under my home directory. I'll do the same with `geneTable`. I'm currently working to do more and more things in the Hadley Wickham way, so I'll be using [devtools](https://github.com/hadley/devtools).


### Create Package with Devtools
Thus, to start the package, I change to my projects directory, start R, and run some commands to get devtools and initialize the package:
```
cd ~/projects
R
install.packages(c("devtools", "roxygen2", "testthat", "lintr"))

## or 
# source("https://bioconductor.org/biocLite.R")
# biocLite(c("devtools", "roxygen2", "testthat", "lintr"))

devtools::create("geneTable")
devtools::test("geneTable") # add testing infrastructure - answer Yes at the prompt
q()
```

That process makes some directories. Now ~/projects/geneTable exists, and looks like this:
```
geneTable/
├── DESCRIPTION
├── NAMESPACE
├── R
├── geneTable.Rproj
└── tests
    ├── testthat
    └── testthat.R
```

## Add Version Control
I want this to be under version control, so I'll initialize a git repository:

```
cd ~/projects/geneTable
git init
```

`devtools::create()` made a .gitignore file, but it's pretty limited. Instead, I'll copy one that I'm cobbling together in [a gist](https://gist.githubusercontent.com/bheavner/4766859540677cafd0a3ed9a27fd9586):

```
r -e 'download.file("https://gist.githubusercontent.com/bheavner/4766859540677cafd0a3ed9a27fd9586/raw/", ".gitignore", "curl")'
```

Now, I can add my files to the repository and do my first commit:

```
git add .
git commit -m "First commit"
```

### Create New Github Repository

Next, I want to have this repository on gitHub, so I need to set up a repository there to use as the origin for this repository. So, I'll start by making a github repo for the R package under the [GAC organization github account](https://github.com/UW-GAC/).

A couple notes on the new repository:

* Include a description
* I choose to make it public (the GAC doesn't have private repositories at the moment)
* I'll initialize without a README, license, or .gitignore (making those will be part of the R package)

Now the [geneTable](https://github.com/UW-GAC/geneTable) repository exists!

### Push Local Working Copy of the Code to GitHub

To push my repository to gitHub, I need to set github as the origin, and do a push:

```
cd ~/projects/geneTable
git remote add origin https://github.com/UW-GAC/geneTable.git
git push -u origin master
```
Now you can see the [first commit for this repository](https://github.com/UW-GAC/geneTable/commit/6527b89f176d4771569f9cb9fc311d626ad3354d) on GitHub.

## Start GitFlow

Before I add any code, I want to start using the [gitflow](http://nvie.com/posts/a-successful-git-branching-model/) approach of having a tagged/versioned long-running *master* branch (I'll add the *develop* and *feature* branches soon). The [gitflow diagram](http://nvie.com/img/git-model@2x.png) uses a **0.1** as the first tag, but I'll follow the [R versioning convention](http://r-pkgs.had.co.nz/description.html#version) and use **0.0.0.9000** as my first tag. (Check out [Yihui Xie's thoughts on versioning](https://yihui.name/en/2013/06/r-package-versioning/) if you'd like more.)


```
git tag 0.0.0.9000
git push --tags
```

Now you can see this commit on GitHub under the list of [tags](https://github.com/UW-GAC/geneTable/tags).

### Add Code to Repository

Since we're using GitFlow, changes to code should mostly happen via short-lived feature branches that branch off of a long-running *develop* branch. So, we need to make those branches so we can add code.

I'll start managing my refactoring with gitflow by making the long-running `develop` branch:
```
git branch develop
```

Then I'll make a new feature branch from develop for working on a first coding task - in this case, copying the original script to the repository so I can start refactoring:
```
git checkout -b features/start develop
```

Now I'm on the *features/start* branch, so I can actually start working with the code. 

R code goes in the `R` folder of the package (Someone named Ben Best has written a nice description of [what goes where in an R package](https://ucsb-bren.github.io/env-info/wk07_package.html)). So, I'll copy the existing script to that directory.

```
cp /projects/topmed/qc/freeze.2a/analysts/jaind/R/make_gencodeV19_aggUnit.R ~/projects/geneTable/R/
```

And that's my first feature. Now that I've done that, I want to merge *features/start* back into *develop* and then refactor from there.

```
git add .
git commit
# add commit message
git checkout develop
git merge --no-ff features/start
```

Now I can safely delete the *features/start* branch.

```
git branch -d features/start
```

### Push Develop Branch to GitHub
Currently, the GithHub repository only has the master branch, so I need to push the Develop Branch to update this code. In general, I think I'll be following this workflow of making feature branches locally, then merging into develop and keeping the long-running develop and master branches on github.

Here's how to create the develop branch on the GitHub repository and push my recent commits:
```
git push --set-upstream origin develop
```

## Begin Refactoring

Our goal in preliminary refactoring is to begin to divide the code up a bit - both in the trivial sense of putting the correct bits in the proper places (thanks again, [Ben Best](https://ucsb-bren.github.io/env-info/wk07_package.html!), and in the more complicated sense of dividing the big script into functions (or, if we're so inclined classes, methods, objects, and other such things). We'll want to eventually make unit tests and add documentation for the functions, and it's easiest to do that as we go, rather than trying to go back and do it later. But we'll get to that later. Let's start with the more trivial part first - we need to move `library()` functions from the script to the DESCRIPTION file, and make sure we have the required metadata (also in the DESCRIPTION file) for our new package.

### Continue to Use gitFlow
I'll make a new feature branch from *develop* for working on this first small refactoring task of moving library dependancies from `library()` calls in the script and editing the DESCRIPTION file:
```
git checkout -b features/deps develop
```

Now I'm on the *features/deps* branch, so can actually start refactoring by adding the `GWASTools` package as a required dependancy for the `geneTable` package. I'll do that the devtools way in R (I could manually edit DESCRIPTION as well, but I'm trying to use devtools more):

```
r
source("https://bioconductor.org/biocLite.R")
biocLite("GWASTools") # because I hadn't installed it before
devtools::use_package("GWASTools")
q()
```

You can check git status to see that this modified the `DESCRIPTION` file. I'll also delete the `library(GWASTools)` line from make_gencodeV19_aggUnit.R. 

Next, I need to do some more editing to the DESCRIPTION file. I just did it with a text editor - the changes are pretty self-explanatory, and are in the file. At that point, I can do a commit on the feature branch:

```
git add DESCRIPTION
git commit
```

Next, I need/want to add a LICENSE file - I just used the MIT file, and got it from my skeleton project like this:

```
r -e 'download.file("https://raw.githubusercontent.com/bheavner/packageTest/master/LICENSE", "LICENSE", "curl")'
```

That's probably good for another commit.

```
git add LICENSE
git commit -m "add MIT LICENSE"
```

**NOTE:** For some reason, devtoools::check() isn't working - I'd hoped it would at this point. This is worth investigating more later...

Meanwhile, I'll merge the *features/deps* branch back into *develop* and push it to gitHub.

```
git checkout develop
git merge --no-ff features/deps
git push
```

Now I can safely delete the *features/deps* branch, leaving just my *master* and *develop* branches, in good shape.

```
git branch -d features/deps
```

### Starting Real Refactoring
To begin real refactoring, I'll start looking over the original script to identify portions I can pull out and make into callable functions. There's no set standard for how big a function should be, or what should go in it. I have a bias towards short functions that don't do much. We'll see if that leads to a messy R/ directory or not. It's always useful to look a bit at [how experienced people build their packages](https://github.com/tidyverse/ggplot2/tree/master/R).

Next up: adding tests with testthat and documentation with roxygen2, using devtools::check() as I iterate....